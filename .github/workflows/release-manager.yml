name: release-manager

on:
  push:
    branches:
      - 'main'
    # Importante: Ignora tags para evitar loop infinito (tag gera push, que gera tag...)
    tags-ignore:
      - '*.*'

permissions:
  contents: write # Necess√°rio para criar Releases e Tags

jobs:
  release:
    name: üöÄ Create Release & Changelog
    runs-on: ubuntu-latest
    # S√≥ roda se o commit n√£o for do pr√≥prio bot de release (seguran√ßa contra loops)
    if: "!contains(github.event.head_commit.message, 'chore(release):')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necess√°rio para ler todo o hist√≥rico de commits e calcular a vers√£o

      # 1. O C√©rebro: Analisa commits e calcula a pr√≥xima vers√£o (SemVer)
      # Se tiver commit "fix:", sobe PATCH (v1.0.0 -> v1.0.1)
      # Se tiver commit "feat:", sobe MINOR (v1.0.0 -> v1.1.0)
      # Se tiver "BREAKING CHANGE:", sobe MAJOR (v1.0.0 -> v2.0.0)
      - name: Calculate Next Version
        id: version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.TOKEN_GITHUB }}
          dry_run: false
          default_bump: patch # Se n√£o achar nada espec√≠fico, assume que √© patch
          fetch_all_tags: true

      # 2. Gera o texto do Changelog baseada nos commits desde a √∫ltima tag
      - name: Generate Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: "configuration.json" # Opcional: pode usar config padr√£o se omitir
          toTag: ${{ steps.version.outputs.new_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}

      # 3. Cria a Release oficial no GitHub
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: Release ${{ steps.version.outputs.new_tag }}
          body: |
            ## üåü O que h√° de novo?
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            *Release gerada automaticamente via GitHub Actions*
          draft: false # Se colocar true, cria um rascunho para aprova√ß√£o humana
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}

      # 4. (Opcional/Avan√ßado) Atualiza o package.json com a nova vers√£o e commita de volta
      # Isso √© √≥timo para Node.js, mas requer cuidado com permiss√µes de push
      - name: Bump version in package.json
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version
          git add package.json
          git commit -m "chore(release): update to ${{ steps.version.outputs.new_tag }}"
          git push origin main
